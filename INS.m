clc;
clear;
close all;
format long
% æµ‹è¯•å§¿æ?æ›´æ–°å‡½æ•?(AttitudeUpdate_single_sample.m)

% åŒ…å«è·¯å¾„,è‹¥æ­¤ä»£ç å®æ•ˆï¼Œæ‰‹åŠ¨æ·»åŠ?
addpath('./data');
addpath('./INS_lib');
addpath('./Kalman_f');
load("err_ekf.mat");
load("DATA.mat")
%                                                                                m/s     ã€?        rad/s     s
load("alldata_800_45_1_0005_0.mat");              %ç†è®ºå¼¹é“,å‘½åæ ¼å¼,    alldata   å‡ºè†›åˆé??  å°„è§’(ä¿¯ä»°)  å‡ºè†›è½¬é??  é‡‡æ ·æ—¶é—´
A_Data = load("TEST_800_45_1_0005_0.mat");        %æ¨¡æ‹Ÿä¼ æ„Ÿå™?,å‘½åæ ¼å¼,     TEST    å‡ºè†›åˆé??  å°„è§’(ä¿¯ä»°)  å‡ºè†›è½¬é??  é‡‡æ ·æ—¶é—´ 
B_SensorData = A_Data.Z_IMU;
D_N = size(B_SensorData,1);
D_T = 0.005;

%                 XYZ                   XYZ 
%Z_IMUåæ ‡ç³»ä¸ºä¸œåŒ—å¤©_xyz,ç®—æ³•çš„åæ ‡ç³»ä¸ºåŒ—ä¸œåœ°_yx(-z),
D_ACC = [B_SensorData(:,5),B_SensorData(:,4),-B_SensorData(:,6)]';         %æŒ‰ç…§ç®—æ³•é¡ºåºé‡æ’åŠ é?Ÿåº¦ä¸‰è½´è¯»æ•°é¡ºåº y ,  x  , -z
%D_GYR = deg2rad(B_SensorData(:,1:3)');
D_GYR = [B_SensorData(:,2),B_SensorData(:,1),-B_SensorData(:,3)]';         %æŒ‰ç…§ç®—æ³•é¡ºåºé‡æ’é™?èºä»ªä¸‰è½´è¯»æ•°é¡ºåºrow,pitch,yaw
                                                                           %                             y    x    -z
% %ç”Ÿæˆå™ªå£°å’Œéšæœºæ¸¸èµ?
% mvnrnd(0,0.001,D_N);
% r_walk = random_walk(D_T,D_N*D_T,D_N,0.0002);
% rw = r_walk(1:D_N,1);
% rw = 0;
% % æ·»åŠ å™ªå£°å’Œéšæœºæ¸¸èµ?
% D_ACC = [B_SensorData(:,5)+mvnrnd(0,1,D_N)+rw,B_SensorData(:,4)+mvnrnd(0,1,D_N)+rw,-B_SensorData(:,6)+mvnrnd(0,1,D_N)+rw]';
% %D_GYR = deg2rad(B_SensorData(:,1:3)');
% D_GYR = [B_SensorData(:,2)+mvnrnd(0,1,D_N)+rw,B_SensorData(:,1)+mvnrnd(0,1,D_N)+rw,-B_SensorData(:,3)+mvnrnd(0,1,D_N)+rw]';
% % æ·»åŠ å™ªå£°å’Œéšæœºæ¸¸èµ?
Euler2(1,:) = Y(:,8)'/180*pi;                                              %row(å¼§åº¦åˆ?)
Euler2(2,:) = Y(:,10)'/180*pi;                                             %pitch(å¼§åº¦åˆ?)
Euler2(3,:) = (Y(:,9)'+90)/180*pi;                                         %yaw(å¼§åº¦åˆ?)
for i = 1:D_N
    qbn2(:,i) = EulerToQuaternion(Euler2(:,i));
    Cbn2(:,:,i) = QuaternionToDCM(qbn2(:,i));
end                                                                           
                                                                                                      
% v(:,1) = Cbn0*[400;0;0]; 
% v(:,1) = Cbn2(:,:,1)*[400;0;0];
v(:,1) = [Y(1,6);Y(1,4);-Y(1,5)];

XYZ(:,1) = [0;0;0];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%å§¿æ?åˆå§‹åŒ–%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Euler(1,1)=0/180*pi;                                                       %åˆå§‹æ¬§æ‹‰è§’row(å¼§åº¦åˆ?)
Euler(2,1)=45/180*pi;                                                      %pitch(å¼§åº¦åˆ?)
Euler(3,1)=90/180*pi;                                                      %yaw(å¼§åº¦åˆ?)

qbn(:,1)=EulerToQuaternion(Euler);                                         %åˆå§‹å§¿æ?å››å…ƒæ•°
Cbn0=QuaternionToDCM(qbn(:,1));                                            %åˆå§‹æ–¹å‘ä½™å¼¦é˜?

BLH(:,1)=[0;0;0];                                                          %åˆå§‹ä½ç½®ï¼ˆçº¬radï¼Œç»radï¼Œé«˜mï¼?
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%å§¿æ?åˆå§‹åŒ–%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%åœ°çƒæ¨¡å‹(WGS84æ¤­çƒå‚æ•°)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
WGS84.a = 6378137.0;                                                       %é•¿åŠè½?
WGS84.b=6356752.3142;                                                      %çŸ­åŠè½?
WGS84.R=6371100;                                                           %å¹³å‡åŠå¾„
WGS84.f = 1/298.257223563;                                                 %æ‰ç‡
WGS84.e2=0.00669437999013;                                                 %ç¬¬ä¸€åå¿ƒç‡å¹³æ–?
WGS84.ep2=0.006739496742227;                                               %ç¬¬äºŒåå¿ƒç‡å¹³æ–?
WGS84.we=7.292115e-5;                                                      %åœ°çƒè‡ªè½¬è§’é?Ÿç‡
WGS84.GM=3.986004418e+14;                                                  %åœ°çƒå¼•åŠ›ä¸ºå¸¸æ•?
% WGS84.ge=9.7803267715;                                                   %èµ¤é“é‡åŠ›åŠ é?Ÿåº¦
WGS84.ge=9.80;                                                             %å¸¸è§„é‡åŠ›åŠ é?Ÿåº¦
WGS84.gp=9.8321863685;                                                     %æåœ°é‡åŠ›åŠ é?Ÿåº¦
%%%%%%%%%%%%%%%%%%%%%%%%%%åœ°çƒæ¨¡å‹(WGS84æ¤­çƒå‚æ•°)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% %%%%%%%%%%%%%%%%%%%%%%%%%%åœ°çƒæ¨¡å‹(çƒå‚æ•?)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% WGS84.a = 6371100;                                                       %å¹³å‡åŠå¾„
% WGS84.b = 6371100;                                                       %å¹³å‡åŠå¾„
% WGS84.R = 6371100;                                                       %å¹³å‡åŠå¾„
% WGS84.f = 0;                                                             %æ‰ç‡
% WGS84.e2 = 1;                                                            %ç¬¬ä¸€åå¿ƒç‡å¹³æ–?
% WGS84.ep2 = 1;                                                           %ç¬¬äºŒåå¿ƒç‡å¹³æ–?
% WGS84.we = 7.292115e-5;                                                  %åœ°çƒè‡ªè½¬è§’é?Ÿç‡
% WGS84.GM = 3.986004418e+14;                                              %åœ°çƒå¼•åŠ›ä¸ºå¸¸æ•?
% WGS84.ge = 9.80;                                                         %èµ¤é“é‡åŠ›åŠ é?Ÿåº¦
% WGS84.gp = 9.80;                                                         %æåœ°é‡åŠ›åŠ é?Ÿåº¦
% %%%%%%%%%%%%%%%%%%%%%%%%%%åœ°çƒæ¨¡å‹(çƒå‚æ•?)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


for i = 2:D_N                                          
%--------------------------------1.å§¿æ?çŸ©é˜µè§£ç®?-----------------------------
    Delta_sita=D_GYR(:,i)*D_T;                                             %ä¸Šä¸€å†å…ƒè§’é?Ÿåº¦å¢é‡                            
    Delta_sita_pre=D_GYR(:,i-1)*D_T;                                       %ä¸Šä¸Šä¸?å†å…ƒè§’é?Ÿåº¦å¢é‡
    [qbn(:,i),qbb(:,i)] = AttitudeUpdate(qbn(:,i-1),v(:,i-1),BLH(:,i-1),Delta_sita_pre,Delta_sita,D_T,WGS84);    
%--------------------------------2.é€Ÿåº¦è§£ç®—---------------------------------
    Deltav=D_ACC(:,i)*D_T;                                                 %ä¸Šä¸€æ—¶åˆ»é€Ÿåº¦å¢é‡
%     Deltav_pre=D_ACC(:,i-1)*D_T;                                         %ä¸Šä¸Šä¸?æ—¶åˆ»é€Ÿåº¦å¢é‡
%     v(:,i) = VelocityUpdate(v(:,i-1),BLH(:,i-1),D_T,Cbn0,Deltav_pre,Deltav,Delta_sita_pre, Delta_sita,WGS84);
    v(:,i) = VelocityUpdate2(v(:,i-1),XYZ(:,i-1),D_T,Cbn2(:,:,i),Deltav,WGS84);
    
    Z_Err_v(i,1) = Y(i,6)' + v(1,i);%xè½´é?Ÿåº¦è¯¯å·®
    Z_Err_v(i,2) = Y(i,4)' - v(2,i);%yè½´é?Ÿåº¦è¯¯å·®
    Z_Err_v(i,3) = Y(i,5)' + v(3,i);%zè½´é?Ÿåº¦è¯¯å·®
%     v(1,i) = v(1,i) - Z_Err_v(i,1)';%è¡¥å¿
%     v(2,i) = v(2,i) + Z_Err_v(i,2)';%è¡¥å¿
%     v(3,i) = v(3,i) - Z_Err_v(i,3)';%è¡¥å¿
%--------------------------------3.ä½ç½®è§£ç®—---------------------------------
    BLH(:,i) = LocationUpdata(BLH(:,i-1),v(:,i),v(:,i-1),D_T,WGS84);
    XYZ(:,i) = LocationUpdata2(XYZ(:,i-1),v(:,i),D_T);
%---------------------------------æ›´æ–°--------------------------------------
    Cbn0=QuaternionToDCM(qbn(:,i));
%     Euler(:,i) = rad2deg(qua2eul(qbn(:,i)));                               %è½¬æ¢ä¸ºå§¿æ€ï¼ˆè§’åº¦åˆ¶ï¼‰
%     Euler_2(:,i) = rad2deg(DCMToEuler(Cbn0));                            %                                                 
%     qre(:,i) = a2qua(deg2rad([Y(i,10),Y(i,8),Y(i,9)]));
end
Euler(:,1) = rad2deg(Euler(:,1));

Z_Err(:,1) = Y(1:D_N-2,3)'-XYZ(1,3:end);
Z_Err(:,2) = Y(1:D_N-2,1)'-XYZ(2,3:end);
Z_Err(:,3) = Y(1:D_N-2,2)'-XYZ(3,3:end);

figure(1);

plot3(XYZ(1,:),XYZ(2,:),XYZ(end,:),'r*');
%axis equal;
hold on;
plot3(Y(:,3),Y(:,1),Y(:,2),'b.');
hold on;
title('å¼¹é“');

legend('IMUè§£ç®—å¼¹é“','ç†è®ºå¼¹é“');


figure(2);
title('Yè½´é?Ÿåº¦');
hold on;
plot(v(2,:),'k');
hold on;
plot(Y(:,4),'b');
legend('IMUè§£ç®—å¼¹é“','ç†è®ºå¼¹é“');


figure(3);
title('Zè½´é?Ÿåº¦');
hold on;
plot(v(3,:),'k');
hold on;
plot(-Y(:,5),'b');
legend('IMUè§£ç®—å¼¹é“','ç†è®ºå¼¹é“');

figure(4);
title('Xè½´é?Ÿåº¦');
hold on;
plot(v(1,:),'k');
hold on;
plot(-Y(:,6),'b');
legend('IMUè§£ç®—å¼¹é“','ç†è®ºå¼¹é“');
